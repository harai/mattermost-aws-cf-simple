# yaml-language-server: $schema=./component.yaml
description: Generated by ${AWS::StackName} cloudformation stack
schemaVersion: 1.0
parameters:
- Version:
    type: string
    description: Mattermost version to use
phases:
- name: build
  steps:
  - name: UpdatePackages
    action: UpdateOS
  - name: EnablePSI
    action: ExecuteBash
    inputs:
      commands:
      - sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="psi=1 /g' /etc/default/grub
      - grub2-mkconfig -o /boot/grub2/grub.cfg
  - name: PutRepoFile
    action: CreateFile
    inputs:
    - path: /etc/yum.repos.d/fedora.repo
      content: |
        [fedora]
        name=Fedora 36 - $basearch
        #baseurl=http://download.example/pub/fedora/linux/releases/36/Everything/$basearch/os/
        metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-36&arch=$basearch
        enabled=1
        countme=1
        metadata_expire=7d
        repo_gpgcheck=0
        type=rpm
        gpgcheck=1
        gpgkey=https://getfedora.org/static/fedora.gpg
        skip_if_unavailable=False

      overwrite: false
  - name: InstallPackages
    action: ExecuteBash
    inputs:
      commands:
      - dnf install --nogpgcheck -y community-mysql-server
      - dnf install -y mlocate jq
  - name: AddUser
    action: ExecuteBash
    inputs:
      commands:
      - groupadd -g 888 mm
      - useradd -u 888 -g 888 --system mm
  - name: DownloadMattermost
    action: WebDownload
    inputs:
    - source: 'https://releases.mattermost.com/{{Version}}/mattermost-{{Version}}-linux-amd64.tar.gz'
      destination: /var/tmp/mattermost-linux-amd64.tar.gz
  - name: InstallMattermost
    action: ExecuteBash
    inputs:
      commands:
      - cd /var/tmp
      - tar xvzf mattermost-linux-amd64.tar.gz
      - mv mattermost /opt
      - rm mattermost-linux-amd64.tar.gz
